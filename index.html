<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Cato Dogs Journal</title>
<style>
:root{--b:#dbe3ef;--a:#2563eb;--a-700:#1d4ed8;--text:#0f172a;--muted:#475569;--fs:19px;--radius:18px;--shadow:0 6px 20px rgba(15,23,42,.10)}
*{box-sizing:border-box}body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#f6f9ff;color:var(--text);margin:0;font-size:var(--fs)}
header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--b);padding:16px 18px;z-index:20}
h1{margin:0;font-weight:800;letter-spacing:.2px}
.container{max-width:1100px;margin:0 auto;padding:18px}
.card{background:#fff;border:1px solid var(--b);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);margin:18px 0}
.banner{display:flex;gap:14px;align-items:center;border:1px dashed var(--b);padding:12px;border-radius:var(--radius);background:#fff}
.banner img{width:96px;height:96px;border-radius:14px;border:1px solid var(--b);object-fit:cover}
.btn{border:1px solid var(--b);background:#fff;border-radius:12px;padding:12px 16px;cursor:pointer;font-size:1rem}
.btn:hover{border-color:#c6d0e2;background:#f8fbff}
.btnp{background:var(--a);color:#fff;border-color:var(--a);box-shadow:0 4px 14px rgba(37,99,235,.35)}
.btnp:hover{background:var(--a-700)}
.tabs{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0 14px}
.tabs label{padding:12px 16px;border:1px solid var(--b);background:#fff;border-radius:12px;cursor:pointer}
input[name="tab"]{position:absolute;left:-9999px}
#tab-overview:checked ~ .panels #panel-overview,
#tab-weights:checked  ~ .panels #panel-weights,
#tab-care:checked     ~ .panels #panel-care,
#tab-birth:checked    ~ .panels #panel-birth,
#tab-bios:checked     ~ .panels #panel-bios,
#tab-vet:checked      ~ .panels #panel-vet,
#tab-photos:checked   ~ .panels #panel-photos{display:block}
.panels > section{display:none}
#tab-overview:checked ~ .tabs label[for="tab-overview"],
#tab-weights:checked  ~ .tabs label[for="tab-weights"],
#tab-care:checked     ~ .tabs label[for="tab-care"],
#tab-birth:checked    ~ .tabs label[for="tab-birth"],
#tab-bios:checked     ~ .tabs label[for="tab-bios"],
#tab-vet:checked      ~ .tabs label[for="tab-vet"],
#tab-photos:checked   ~ .tabs label[for="tab-photos"]{background:var(--a);color:#fff;border-color:var(--a)}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid var(--b);padding:12px;text-align:center;font-size:1rem}
th{background:#f1f6ff}
.form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(190px,1fr));gap:12px;margin:10px 0}
.form-grid input,.form-grid select,.form-grid textarea{width:100%;padding:12px;border:1px solid var(--b);border-radius:12px;font-size:1rem}
.legend{display:flex;gap:12px;flex-wrap:wrap;margin:10px 0}
.legend label{display:flex;gap:10px;align-items:center;border:1px solid var(--b);border-radius:12px;background:#fff;padding:10px 12px}
.legend label span{display:inline-block;width:18px;height:18px;border-radius:9px}
#chart,#lengthChart{width:100%;height:760px}
.week-tile{border:2px solid var(--a);border-radius:14px;padding:16px;margin:12px 0;background:#fff;display:flex;justify-content:space-between;align-items:center}
.complete-btn{background:var(--a);color:#fff;border:none;border-radius:12px;padding:12px 16px;cursor:pointer}
.photos-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px}
.photos-grid img{width:100%;border-radius:10px;border:1px solid var(--b)}
#fsModal{position:fixed;inset:0;background:rgba(0,0,0,.84);display:none;align-items:center;justify-content:center;z-index:50}
#fsInner{background:#fff;border-radius:14px;max-width:98vw;max-height:92vh;padding:10px}
#fsInner svg{width:92vw;height:80vh}
#fsClose{position:absolute;top:12px;right:16px;background:#ef4444;color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
@media (max-width:640px){:root{--fs:20px}.banner img{width:84px;height:84px}#chart,#lengthChart{height:680px}}
</style>
</head>
<body>
<header><h1>Cato Dogs Journal</h1></header>
<main class="container">
  <div class="card banner">
    <img id="thorImg" src="photos/thor.jpg" alt="Thor"/>
    <img id="miaImg"  src="photos/mia.jpg"  alt="Mia"/>
    <div style="font-weight:600">Thor (Cane Corso) • Mia (Rottweiler)</div>
    <label class="btn" style="margin-left:auto">Update Thor<input id="pickThor" type="file" accept="image/*" hidden></label>
    <label class="btn">Update Mia<input id="pickMia" type="file" accept="image/*" hidden></label>
  </div>

  <input type="radio" name="tab" id="tab-overview" checked>
  <input type="radio" name="tab" id="tab-weights">
  <input type="radio" name="tab" id="tab-care">
  <input type="radio" name="tab" id="tab-birth">
  <input type="radio" name="tab" id="tab-bios">
  <input type="radio" name="tab" id="tab-vet">
  <input type="radio" name="tab" id="tab-photos">

  <div class="tabs">
    <label for="tab-overview">Overview</label>
    <label for="tab-weights">Weights & Lengths</label>
    <label for="tab-care">Care Plan</label>
    <label for="tab-birth">Birth Log</label>
    <label for="tab-bios">Bios</label>
    <label for="tab-vet">Vet & Worming</label>
    <label for="tab-photos">Photos</label>
  </div>

  <div class="panels card">
    <section id="panel-overview">
      <h2>Overview</h2>
      <div id="ovSummary"></div>
      <details style="margin-top:10px"><summary><b>Notes</b></summary><div id="ovNotes" style="color:var(--muted)"></div></details>
    </section>

    <section id="panel-weights">
      <h2>Weights & Lengths</h2>
      <div class="card" style="margin:12px 0;background:#f8fbff">
        <h3 style="margin-top:0">Add new entry</h3>
        <div class="form-grid">
          <label>Pup
            <select id="wlPup">
              <option value="pup2">Pup 2 (Blue)</option>
              <option value="pup3">Pup 3 (Pink)</option>
              <option value="pup5">Pup 5 (Orange)</option>
            </select>
          </label>
          <label>Day<input type="number" id="wlDay" min="1" placeholder="e.g., 15"></label>
          <label>Weight (g)<input type="number" id="wlWeight" min="1" placeholder="grams"></label>
          <label>Length (cm)<input type="number" id="wlLength" step="0.1" min="1" placeholder="centimetres"></label>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button id="addWL" class="btnp" type="button">Save entry</button>
          <button id="expW" class="btn" type="button">Download weights.json</button>
          <button id="expL" class="btn" type="button">Download lengths.json</button>
          <button id="expAll" class="btn" type="button">Download ALL data (bundle)</button>
          <button id="toggleCharts" class="btn" type="button">Hide charts</button>
        </div>
      </div>

      <div class="legend" id="legend"></div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:6px 0">
        <button id="fsWeightBtn" class="btn" type="button">Full‑screen weights chart</button>
      </div>
      <svg id="chart" viewBox="0 0 960 520" preserveAspectRatio="xMidYMid meet"></svg>

      <details open style="margin-top:12px">
        <summary><b>Length Growth Chart</b></summary>
        <div class="legend" id="legendL"></div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:6px 0">
          <button id="fsLengthBtn" class="btn" type="button">Full‑screen length chart</button>
        </div>
        <svg id="lengthChart" viewBox="0 0 960 520" preserveAspectRatio="xMidYMid meet"></svg>
      </details>

      <details open style="margin-top:12px">
        <summary><b>Data tables</b></summary>
        <h3>Weights</h3>
        <table id="tblW"><thead><tr><th>Day</th><th>Pup 2</th><th>Pup 3</th><th>Pup 5</th></tr></thead><tbody></tbody></table>
        <h3 style="margin-top:16px">Lengths</h3>
        <table id="tblL"><thead><tr><th>Day</th><th>Pup 2</th><th>Pup 3</th><th>Pup 5</th></tr></thead><tbody></tbody></table>
      </details>
    </section>

    <section id="panel-care">
      <h2>Care Plan</h2>
      <div id="careTiles"></div>
      <details><summary>Completed Weeks</summary><div id="completedWeeks"></div></details>
    </section>

    <section id="panel-birth">
      <h2>Birth Log</h2>
      <table id="birthTable"><thead><tr><th>#</th><th>Time</th><th>Sex</th><th>Status</th><th>Placenta</th><th>Notes</th></tr></thead><tbody></tbody></table>
    </section>

    <section id="panel-bios">
      <h2>Editable Bios (Parents & Pups)</h2>
      <div id="bioList"></div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
        <button id="expBios" class="btn" type="button">Download dogs.json</button>
      </div>
    </section>

    <section id="panel-vet">
      <h2>Vet & Worming</h2>
      <div class="card" style="background:#f8fbff">
        <div class="form-grid">
          <label>Who<select id="evWho"><option>Mia</option><option>Thor</option><option>Pup 2</option><option>Pup 3</option><option>Pup 5</option></select></label>
          <label>Date<input type="date" id="evDate"></label>
          <label>Type<select id="evType"><option>Vet visit</option><option>Worming</option><option>Vaccination</option><option>Microchip</option><option>Flea/Tick</option><option>Other</option></select></label>
          <label>Cost (AU$)<input type="number" id="evCost" step="0.01" placeholder="0.00"></label>
          <label style="grid-column:1/-1">Notes<input type="text" id="evNotes" placeholder="e.g., C3 @ Melton Family Vets"></label>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button id="addEvent" class="btnp" type="button">Add record</button>
          <button id="expCSV" class="btn" type="button">Download events.csv</button>
        </div>
      </div>
      <table id="tblEvents"><thead><tr><th>Date</th><th>Who</th><th>Type</th><th>Cost</th><th>Notes</th></tr></thead><tbody></tbody></table>
    </section>

    <section id="panel-photos">
      <h2>Photos</h2>
      <input type="file" id="addPhoto" accept="image/*" multiple>
      <div class="photos-grid" id="photoGrid"></div>
    </section>
  </div>
</main>

<div id="fsModal"><button id="fsClose">Close</button><div id="fsInner"></div></div>

<script>
function blobDownload(name, blob){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 1500); }
function setLocalImg(input, key, imgEl){ input.addEventListener('change', e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ localStorage.setItem(key, r.result); imgEl.src=r.result; }; r.readAsDataURL(f); }); const exist=localStorage.getItem(key); if(exist) imgEl.src=exist; }
setLocalImg(document.getElementById('pickThor'),'thor_local',document.getElementById('thorImg'));
setLocalImg(document.getElementById('pickMia'),'mia_local',document.getElementById('miaImg'));

function simpleLineChart(svgId, rows, series, xKey, yPad, legendId){
  const svg=document.getElementById(svgId); while(svg.firstChild) svg.removeChild(svg.firstChild);
  if(!rows.length) return;
  const W=960,H=520,M={l:90,r:28,t:32,b:78}, iw=W-M.l-M.r, ih=H-M.t-M.b;
  const xs=rows.map(r=>r[xKey]); const maxX=Math.max(...xs), minX=Math.min(...xs);
  const vals=[]; series.forEach(s=> rows.forEach(r=>{ if(r[s.k]!=null) vals.push(r[s.k]); }));
  const minY=Math.floor((Math.min(...vals)-yPad)/20)*20, maxY=Math.ceil((Math.max(...vals)+yPad)/20)*20;
  const X=d=>M.l + ((d-minX) / (Math.max(15,maxX)-minX)) * iw;
  const Y=v=>M.t + ih - ((v-minY)/(maxY-minY)) * ih;
  function L(x1,y1,x2,y2,c){const e=document.createElementNS('http://www.w3.org/2000/svg','line'); e.setAttribute('x1',x1);e.setAttribute('y1',y1);e.setAttribute('x2',x2);e.setAttribute('y2',y2);e.setAttribute('stroke',c||'#e2e8f0'); e.setAttribute('stroke-width','1'); return e;}
  function T(x,y,t,anc='middle'){const e=document.createElementNS('http://www.w3.org/2000/svg','text'); e.setAttribute('x',x);e.setAttribute('y',y);e.setAttribute('font-size','18');e.setAttribute('fill','#334155');e.setAttribute('text-anchor',anc); e.textContent=t; return e;}
  function P(d,c,w=3.9){const e=document.createElementNS('http://www.w3.org/2000/svg','path'); e.setAttribute('d',d); e.setAttribute('fill','none'); e.setAttribute('stroke',c); e.setAttribute('stroke-width',w); return e;}
  function C(cx,cy,c){const e=document.createElementNS('http://www.w3.org/2000/svg','circle'); e.setAttribute('cx',cx); e.setAttribute('cy',cy); e.setAttribute('r',6); e.setAttribute('fill',c); return e;}
  for(let gy=minY; gy<=maxY; gy+=50){ const yy=Y(gy); svg.appendChild(L(M.l,yy,W-M.r,yy)); }
  svg.appendChild(L(M.l,M.t,M.l,H-M.b,'#94a3b8')); svg.appendChild(L(M.l,H-M.b,W-M.r,H-M.b,'#94a3b8'));
  const step=(window.innerWidth<=768)?2:1; for(let d=minX; d<=Math.max(15,maxX); d+=step){ svg.appendChild(T(X(d),H-M.b+28,'Day '+d)); }
  for(let gy=minY; gy<=maxY; gy+=100){ svg.appendChild(T(M.l-18,Y(gy)+5,gy,'end')); }
  if(legendId){
    const legend=document.getElementById(legendId); legend.innerHTML='';
    series.forEach(s=>{
      const lab=document.createElement('label');
      const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=true; s.cb=cb;
      const sw=document.createElement('span'); sw.style.background = s.c;
      const tx=document.createElement('span'); tx.textContent=' '+s.name;
      lab.appendChild(cb); lab.appendChild(sw); lab.appendChild(tx);
      legend.appendChild(lab);
    });
  }
  const layer=document.createElementNS('http://www.w3.org/2000/svg','g'); svg.appendChild(layer);
  function draw(){
    while(layer.firstChild) layer.removeChild(layer.firstChild);
    series.forEach(s=>{
      if(s.cb && !s.cb.checked) return;
      let d=''; rows.forEach(r=>{ const v=r[s.k]; if(v==null) return; d+=(d?'L':'M')+X(r[xKey])+' '+Y(v)+' '; });
      if(d) layer.appendChild(P(d,s.c));
      rows.forEach(r=>{ const v=r[s.k]; if(v==null) return; layer.appendChild(C(X(r[xKey]),Y(v),s.c)); });
    });
  }
  if(legendId) document.getElementById(legendId).addEventListener('change', draw);
  draw();
}

async function loadOverview(){
  try {
    const ov = await fetch('data/overview.json',{cache:'no-store'}).then(r=>r.json());
    const s = ov?.litter_summary || {};
    document.getElementById('ovSummary').innerHTML =
      `<table><tr><th>Total Pups</th><th>Live</th><th>Stillborn</th><th>Whelping Window</th></tr>
        <tr><td>${s.total_pups ?? ''}</td><td>${s.live ?? ''}</td><td>${s.stillborn ?? ''}</td><td>${s.whelping_window ?? ''}</td></tr>
      </table>`;
    document.getElementById('ovNotes').textContent = ov?.notes || '';
  } catch (e) {
    console.warn('overview.json failed:', e);
    document.getElementById('ovSummary').innerHTML =
      `<div style="color:#64748b">Overview not available (check /data/overview.json)</div>`;
  }

  try {
    const bl = await fetch('data/birth_log.json',{cache:'no-store'}).then(r=>r.json());
    const tb = document.querySelector('#birthTable tbody'); tb.innerHTML='';
    (bl || []).forEach((r,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.p || i+1}</td><td>${r.time || ''}</td><td>${r.sex || ''}</td>
                      <td>${r.status || ''}</td><td>${r.placenta || ''}</td><td>${r.notes || ''}</td>`;
      tb.appendChild(tr);
    });
  } catch (e) {
    console.warn('birth_log.json failed:', e);
  }
}
loadOverview();

let baseW=[], baseL=[], addW=JSON.parse(localStorage.getItem('add_weights')||'[]'), addL=JSON.parse(localStorage.getItem('add_lengths')||'[]');
function mergeByDay(base, add){ const m={}; base.forEach(r=>m[r.day]=Object.assign({},r)); add.forEach(r=>m[r.day]=Object.assign({},m[r.day]||{day:r.day},r)); return Object.values(m).sort((a,b)=>a.day-b.day); }
function renderTables(W,L){
  const tw=document.querySelector('#tblW tbody'); tw.innerHTML=''; W.forEach(r=>{ tw.innerHTML += `<tr><td>${r.day}</td><td>${r.pup2??''}</td><td>${r.pup3??''}</td><td>${r.pup5??''}</td></tr>`; });
  const tl=document.querySelector('#tblL tbody'); tl.innerHTML=''; L.forEach(r=>{ tl.innerHTML += `<tr><td>${r.day}</td><td>${r.pup2??''}</td><td>${r.pup3??''}</td><td>${r.pup5??''}</td></tr>`; });
}
function renderWL(){
  const W = mergeByDay(baseW, addW);
  const L = mergeByDay(baseL, addL);
  renderTables(W,L);
  simpleLineChart('chart', W, [
    {k:'pup2', name:'Pup 2 (Blue)',  c:'#1f77b4'},
    {k:'pup3', name:'Pup 3 (Pink)',  c:'#e45756'},
    {k:'pup5', name:'Pup 5 (Orange)',c:'#4c9a2a'},
  ], 'day', 60, 'legend');
  simpleLineChart('lengthChart', L, [
    {k:'pup2', name:'Pup 2 (Blue)',  c:'#1f77b4'},
    {k:'pup3', name:'Pup 3 (Pink)',  c:'#e45756'},
    {k:'pup5', name:'Pup 5 (Orange)',c:'#4c9a2a'},
  ], 'day', 2, 'legendL');
}
async function loadWL(){
  try {
    const jw = await fetch('data/weights.json',{cache:'no-store'}).then(r=>r.json());
    baseW = jw.weights || [];
  } catch(e){ console.warn('weights.json failed:', e); baseW = []; }

  try {
    const jl = await fetch('data/lengths.json',{cache:'no-store'}).then(r=>r.json());
    baseL = jl.records || [];
  } catch(e){ console.warn('lengths.json failed:', e); baseL = []; }

  renderWL();
}
loadWL();
document.getElementById('addWL').addEventListener('click',()=>{
  const who=wlPup.value; const day=parseInt(wlDay.value||'0',10);
  const w=wlWeight.value?parseFloat(wlWeight.value):null;
  const l=wlLength.value?parseFloat(wlLength.value):null;
  if(!day || (!w && !l)) return alert('Enter a Day and at least a Weight or Length.');
  if(w!=null){ let r=addW.find(x=>x.day===day); if(!r){r={day}; addW.push(r);} r[who]=w; localStorage.setItem('add_weights',JSON.stringify(addW)); }
  if(l!=null){ let r=addL.find(x=>x.day===day); if(!r){r={day}; addL.push(r);} r[who]=l; localStorage.setItem('add_lengths',JSON.stringify(addL)); }
  wlDay.value=''; wlWeight.value=''; wlLength.value=''; renderWL();
});
document.getElementById('expW').addEventListener('click',()=>{
  const merged=mergeByDay(baseW,addW);
  blobDownload('weights.json', new Blob([JSON.stringify({dob:'2025-09-12',weights:merged},null,2)],{type:'application/json'}));
});
document.getElementById('expL').addEventListener('click',()=>{
  const merged=mergeByDay(baseL,addL);
  blobDownload('lengths.json', new Blob([JSON.stringify({units:'cm',records:merged},null,2)],{type:'application/json'}));
});
document.getElementById('expAll').addEventListener('click',()=>{
  const bundle = {
    overview: JSON.parse(localStorage.getItem('overview_override')||'null'),
    weights: {dob:'2025-09-12', weights: mergeByDay(baseW,addW)},
    lengths: {units:'cm', records: mergeByDay(baseL,addL)},
    dogs: JSON.parse(localStorage.getItem('bios')||'null'),
    events: JSON.parse(localStorage.getItem('events')||'[]')
  };
  blobDownload('journal_export.json', new Blob([JSON.stringify(bundle,null,2)],{type:'application/json'}));
});

const fsModal = document.getElementById('fsModal');
const fsInner = document.getElementById('fsInner');
document.getElementById('fsClose').onclick = ()=>{ fsModal.style.display='none'; fsInner.innerHTML=''; };
function openFsFrom(svgId){
  const src = document.getElementById(svgId);
  const clone = src.cloneNode(true);
  clone.removeAttribute('id');
  fsInner.innerHTML=''; fsInner.appendChild(clone); fsModal.style.display='flex';
}
document.getElementById('fsWeightBtn').onclick = ()=> openFsFrom('chart');
document.getElementById('fsLengthBtn').onclick = ()=> openFsFrom('lengthChart');

const DOB='2025-09-12', WEEK_MS=7*24*3600*1000;
const careWeeks=[
  {w:2, text:"Worming (pyrantel); gentle handling"},
  {w:3, text:"Handling & sounds; nails; water dish"},
  {w:4, text:"Second worming; start puppy mush; introduce Thor carefully"},
  {w:6, text:"Vet check; 1st vaccination; microchip; short car rides"},
  {w:7, text:"Crate naps; basic training; surfaces & noises"},
  {w:8, text:"Final worming; flea/tick per vet; rehoming prep"}
];
let doneWeeks = JSON.parse(localStorage.getItem('done_weeks')||'[]');
function weekStart(dob, w){ const d=new Date(dob); return new Date(d.getTime()+ (w-1)*WEEK_MS); }
function isOverdue(dob, w){ return new Date() > new Date(weekStart(dob,w).getTime()+WEEK_MS); }
function renderCare(){
  const wrap=document.getElementById('careTiles'); const comp=document.getElementById('completedWeeks'); wrap.innerHTML=''; comp.innerHTML='';
  careWeeks.forEach(k=>{
    const tile=document.createElement('div'); tile.className='week-tile';
    if(isOverdue(DOB,k.w) && !doneWeeks.includes(k.w)) tile.style.borderColor='#dc2626';
    tile.innerHTML=`<span><b>Week ${k.w}</b> — ${k.text}</span>`;
    const btn=document.createElement('button'); btn.textContent='Complete'; btn.className='complete-btn';
    btn.onclick=()=>{ if(!doneWeeks.includes(k.w)) { doneWeeks.push(k.w); localStorage.setItem('done_weeks',JSON.stringify(doneWeeks)); renderCare(); } };
    if(doneWeeks.includes(k.w)){ comp.appendChild(tile); } else { tile.appendChild(btn); wrap.appendChild(tile); }
  });
}
renderCare();

let BIO = [];
async function loadBios(){
  try {
    const fromRepo = await fetch('data/dogs.json',{cache:'no-store'}).then(r=>r.json());
    const local = JSON.parse(localStorage.getItem('bios')||'null');
    BIO = Array.isArray(local) ? local : fromRepo;
  } catch(e){
    console.warn('dogs.json failed:', e);
    BIO = JSON.parse(localStorage.getItem('bios')||'[]');
  }
  renderBios();
}
function bioCard(d,i){
  const isPup = (d.id || '').startsWith('pup');
  const r = d.rehoming || {};
  const wrap=document.createElement('div'); wrap.className='card';
  wrap.innerHTML=`
    <div class="form-grid">
      <label>Name<input value="${d.name || ''}" data-k="name" data-i="${i}"></label>
      <label>Breed<input value="${d.breed || ''}" data-k="breed" data-i="${i}"></label>
      <label>Sex<input value="${d.sex || ''}" data-k="sex" data-i="${i}"></label>
      <label>DOB<input value="${d.dob || ''}" data-k="dob" data-i="${i}"></label>
      <label>Weight<input value="${d.weight || ''}" data-k="weight" data-i="${i}"></label>
      <label>Microchip<input value="${d.microchip || ''}" data-k="microchip" data-i="${i}"></label>
      <label style="grid-column:1/-1">Last vet<input value="${d.last_vet || ''}" data-k="last_vet" data-i="${i}"></label>
      <label style="grid-column:1/-1">Notes<textarea rows="2" data-k="notes" data-i="${i}">${d.notes || ''}</textarea></label>
      ${isPup ? `<div style="grid-column:1/-1"><b>Rehoming</b></div>
      <label>Price (AU$)<input value="${r.price_aud || ''}" data-r="price_aud" data-i="${i}"></label>
      <label>Available from<input type="date" value="${r.available_from || ''}" data-r="available_from" data-i="${i}"></label>
      <label>Adoption link<input value="${r.adoption_link || ''}" data-r="adoption_link" data-i="${i}"></label>
      <label>Desexing<input value="${r.desexing || ''}" data-r="desexing" data-i="${i}"></label>
      <label>Vaccinations<input value="${r.vaccinations || ''}" data-r="vaccinations" data-i="${i}"></label>
      <label>Worming<input value="${r.worming || ''}" data-r="worming" data-i="${i}"></label>
      <label>Flea/Tick<input value="${r.flea_tick || ''}" data-r="flea_tick" data-i="${i}"></label>`:''}
    </div>`;
  return wrap;
}
function renderBios(){
  const host=document.getElementById('bioList'); host.innerHTML='';
  BIO.forEach((d,i)=>{ host.appendChild(bioCard(d,i)); });
  host.querySelectorAll('input[data-k],textarea[data-k]').forEach(inp=>{
    inp.addEventListener('input', e=>{ const i=+e.target.dataset.i, k=e.target.dataset.k; BIO[i][k]=e.target.value; localStorage.setItem('bios', JSON.stringify(BIO)); });
  });
  host.querySelectorAll('input[data-r]').forEach(inp=>{
    inp.addEventListener('input', e=>{ const i=+e.target.dataset.i, k=e.target.dataset.r; BIO[i].rehoming = BIO[i].rehoming||{}; BIO[i].rehoming[k]=e.target.value; localStorage.setItem('bios', JSON.stringify(BIO)); });
  });
}
document.getElementById('expBios').onclick=()=>{
  blobDownload('dogs.json', new Blob([JSON.stringify(BIO,null,2)],{type:'application/json'}));
};
loadBios();

let EV = JSON.parse(localStorage.getItem('events')||'[]');
function renderEvents(){ const tb=document.querySelector('#tblEvents tbody'); tb.innerHTML=''; EV.forEach(e=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${e.date||''}</td><td>${e.who||''}</td><td>${e.type||''}</td><td>${e.cost||''}</td><td>${e.notes||''}</td>`; tb.appendChild(tr); }); }
renderEvents();
document.getElementById('addEvent').addEventListener('click',()=>{
  const row={who:evWho.value,date:evDate.value,type:evType.value,cost:evCost.value,notes:evNotes.value};
  EV.push(row); localStorage.setItem('events', JSON.stringify(EV)); renderEvents();
});

let photos=JSON.parse(localStorage.getItem('gallery')||'[]');
function renderGallery(){ const g=document.getElementById('photoGrid'); g.innerHTML=''; photos.forEach(u=>{ const img=document.createElement('img'); img.src=u; g.appendChild(img); }); }
renderGallery();
document.getElementById('addPhoto').addEventListener('change',e=>{
  [...e.target.files].forEach(f=>{ const r=new FileReader(); r.onload=()=>{ photos.push(r.result); localStorage.setItem('gallery',JSON.stringify(photos)); renderGallery(); }; r.readAsDataURL(f); });
});
</script>
</body>
</html>
